# ProGuard Configuration for TimechoDB Security Build
# This configuration obfuscates ALL IoTDB.TimechoDB project components while preserving functionality

# Basic settings
-dontskipnonpubliclibraryclasses
-verbose
-dontwarn
-dontnote
-dontoptimize
-dontshrink

# for debugging purposes, you can enable the following line to see the final configuration used
# -addconfigurationdebugging

-target 1.8
# Keep main entry points
# -keep public class * {
#     public static void main(java.lang.String[]);
# }

-keepclasseswithmembers public class * {
    public static void main(java.lang.String[]);
}

-keep class org.apache.iotdb.service.** {
    public *;
}

-keep class org.apache.iotdb.**.service.** {
    public *;
}

-keep class com.timecho.iotdb.service.** {
    public *;
}

-keep class org.apache.iotdb.threadpool.** {
    public *;
}

-keep class org.apache.iotdb.**.threadpool.** {
    public *;
}

-keep class org.apache.iotdb.db.storageengine.pool.** {
    public *;
}

-keep class org.apache.iotdb.commons.** {
    public *;
}

-keep class org.apache.iotdb.consensus.ratis.metrics.IoTDBMetricRegistry {
    public *;
    <fields>;
}

-keep class org.apache.iotdb.consensus.ratis.metrics.GaugeProxy {
}

-keepclassmembers class org.apache.iotdb.db.conf.IoTDBConfig {
    public *;
    <fields>;
}

-keepclassmembers class org.apache.iotdb.confignode.conf.ConfigNodeConfig {
    public *;
    <fields>;
}

-keep class * implements org.apache.iotdb.commons.service.IService {
    public *;
}

-keep interface org.apache.iotdb.db.storageengine.buffer.CacheHitRatioMonitorMXBean {
    *;
}
-keep class org.apache.iotdb.db.protocol.session.SessionManager {
    *;
}
-keep class org.apache.iotdb.db.storageengine.dataregion.flush.FlushManager {
    *;
}
-keep class * extends org.apache.iotdb.commons.service.ThriftService {
    *;
}
-keep class org.apache.iotdb.commons.service.metric.MetricService {
    *;
}
-keep class org.apache.iotdb.db.storageengine.rescon.disk.strategy.** {
    *;
}
-keep class org.apache.iotdb.db.protocol.** {
    *;
}

-keep class org.apache.iotdb**.api.** {
    *;
}
-keep class org.apache.iotdb.cli.** {
    *;
}
-keep class org.apache.iotdb.exception.** {
    *;
}
-keep class org.apache.iotdb.tool.** {
    *;
}
-keep class org.apache.iotdb.isession.** {
    *;
}
-keep class org.apache.iotdb.jdbc.** {
    *;
}
-keep class org.apache.iotdb.session.** {
    *;
}
-keep class org.apache.iotdb.rpc.** {
    *;
}
-keep interface org.apache.tsfile.annotations.** {
    *;
}
-keep class org.apache.tsfile.enums.** {
    *;
}
-keep class org.apache.tsfile.encrypt.UNENCRYPTED {
    *;
}
-keep class org.apache.iotdb.db.protocol.rest.** {
    *;
}

-keepclassmembers class org.apache.iotdb.db.protocol.client.ConfigNodeClient {
    *;
}

-keepclassmembers class org.apache.iotdb.db.schemaengine.schemaregion.impl.SchemaRegionMemoryImpl {
    <init>(org.apache.iotdb.db.schemaengine.schemaregion.ISchemaRegionParams);
}
-keepclassmembers class org.apache.iotdb.db.schemaengine.schemaregion.impl.SchemaRegionPBTreeImpl {
    <init>(org.apache.iotdb.db.schemaengine.schemaregion.ISchemaRegionParams);
}
-keep class org.apache.iotdb.db.queryengine.plan.parser.ASTVisitor
-keep class org.apache.iotdb.db.qp.sql.SqlLexer
-keep class org.apache.iotdb.db.qp.sql.IoTDBSqlParser
-keep class org.apache.iotdb.db.queryengine.plan.planner.distribution.SourceRewriter
-keep class org.apache.iotdb.db.queryengine.plan.planner.distribution.DistributionPlanContext
-keep class org.apache.iotdb.db.queryengine.plan.planner.LogicalPlanVisitor
-keep class org.apache.iotdb.db.queryengine.plan.planner.plan.LogicalQueryPlan
-keep class org.apache.iotdb.db.storageengine.dataregion.memtable.TsFileProcessor
-keep class org.apache.iotdb.db.queryengine.plan.parser.StatementGenerator

# META-INF/services files
-keep class org.apache.iotdb.consensus.ratis.metrics.MetricRegistryManager {
    public *;
}

-keep class org.apache.iotdb.metrics.core.reporter.IoTDBJmxReporter {
    public *;
}

-keep class org.apache.iotdb.metrics.core.IoTDBMetricManager {
    public *;
}

-keep class com.timecho.iotdb.rpc.IPCheckListServerContextFactory {
    public *;
}

-keep class org.apache.iotdb.db.protocol.mqtt.JSONPayloadFormatter {
    public *;
}

-keep class org.apache.iotdb.db.protocol.mqtt.LinePayloadFormatter {
    public *;
}

-keep class org.apache.iotdb.jdbc.IoTDBDriver {
    public *;
}

-keep class org.apache.iotdb.consensus.ratis.RatisConsensus {
    public *;
}

-keep class org.apache.iotdb.consensus.simple.SimpleConsensus {
    public *;
}

-keep class org.apache.iotdb.consensus.iot.IoTConsensus {
    public *;
}

-keep class org.apache.iotdb.consensus.iot.IoTConsensusV2 {
    public *;
}

-keep class org.apache.iotdb.consensus.pipe.PipeConsensus {
    public *;
}

-keep class org.apache.iotdb.commons.partition.executor.hash.BKDRHashExecutor {
    public *;
}

-keep class org.apache.iotdb.commons.auth.authorizer.LocalFileAuthorizer {
    public *;
}

-keep class org.apache.iotdb.db.conf.IoTDBDescriptor {
    public *;
}

-keep class org.apache.iotdb.db.conf.rest.IoTDBRestServiceDescriptor {
    public *;
}

-keep class org.apache.iotdb.commons.conf.CommonDescriptor {
    public *;
}

-keep class org.apache.iotdb.session.subscription.consumer.base {
    public *;
}

-keep class org.apache.iotdb.db.pipe.source.dataregion.IoTDBDataRegionSource {
    public *;
}

-keep class org.apache.iotdb.commons.security.encrypt.MessageDigestEncrypt {
    public *;
}

-keep class org.apache.iotdb.db.storageengine.dataregion.wal.io.LogWriter {
    public *;
}

-keep class com.timecho.iotdb.dataregion.migration.MigrationTaskManager {
    public *;
}

-keep class com.timecho.iotdb.dataregion.compaction.execute.task.SharedStorageCompactionTask {
    public *;
}

-keep class com.timecho.iotdb.dataregion.compaction.execute.recover.SharedStorageCompactionRecoverTask {
    public *;
}

-keep class com.timecho.iotdb.dataregion.compaction.selector.impl.SharedStorageCompactionSelector {
    public *;
}

-keep class com.timecho.iotdb.dataregion.compaction.execute.task.SharedStorageCompactionTask {
    public *;
}

-keep class com.timecho.iotdb.os.fileSystem.OSTsFileOutput {
    public *;
}

-keep class com.timecho.iotdb.os.fileSystem.OSTsFileInput {
    public *;
}

-keep class com.timecho.iotdb.os.fileSystem.OSFile {
    public *;
}
-keep class org.apache.tsfile.block.column.** {
    *;
}
-keepclassmembers class org.apache.tsfile.block.column.ColumnBuilderStatus {
    <fields>;
}
-keepclassmembers class org.apache.tsfile.block.TsBlockBuilderStatus {
    <fields>;
}
-keep class org.apache.tsfile.read.common.block.column.** {
    public *;
}
-keep class org.apache.iotdb.db.service.RestService {
  *;
}
-keep class org.apache.iotdb.db.queryengine.plan.relational.sql.ast.** {
  public *;
}
-keep class org.apache.tsfile.utils.** {
  *;
}

-keep class **.*Properties* {
    *;
}

-keep class * implements java.sql.Driver

-keep class com.timecho.iotdb.commons.encrypt.AES128.AES128
-keep class com.timecho.iotdb.commons.encrypt.SM4128.SM4128

# Keep enums (often used in configurations and APIs)
-keepclassmembers enum * {
    public static **[] values();
    public static ** valueOf(java.lang.String);
    **[] $VALUES;
    public *;
}

# Keep serialization related
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private static final java.io.ObjectStreamField[] serialPersistentFields;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
    java.lang.Object writeReplace();
    java.lang.Object readResolve();
}

# Keep attributes for debugging and reflection
-keepattributes *Annotation*
-keepattributes Signature
-keepattributes InnerClasses
-keepattributes EnclosingMethod
-keepattributes Exceptions
# -keepattributes LineNumberTable
# -keepattributes SourceFile

# Keep native method names
-keepclasseswithmembernames class * {
    native <methods>;
}


# Keep JMX MBeans
-keep class * implements javax.management.MXBean {
    *;
}


-keep class **.*MBean {
    *;
}

# Keep Thrift generated classes structure (important for IoTDB)
-keep class org.apache.iotdb.**.thrift.** {
    public *;
    protected *;
}

# Keep essential service interfaces
-keep interface org.apache.iotdb.**.I* {
    *;
}

-keep interface org.apache.iotdb.**.api.** {
    *;
}
-keep class org.apache.iotdb.**.api.** {
    *;
}
-keep class org.apache.tsfile.write.record.Tablet {
    *;
}

# Keep exception and error classes for debugging
-keep class **.*Exception* {
    <init>(...);
    public *;
}

-keep class **.*Error* {
    <init>(...);
    public *;
}

# Keep factory and builder patterns
-keep class **.*Factory* {
    public *;
    protected *;
}

-keep class **.*Builder* {
    public *;
    protected *;
}


# Obfuscation dictionary configuration
-obfuscationdictionary obfuscation-dict.txt
-classobfuscationdictionary obfuscation-dict.txt
-packageobfuscationdictionary obfuscation-dict.txt

# Preserve original package names for REST/OpenAPI resources so hard-coded reflection strings remain valid
-keeppackagenames org.apache.iotdb.db.protocol.rest
# Adapt string literals that reference class names to updated names (safety net if any slip through)
-adaptclassstrings
-keepdirectories org/apache/iotdb/db/protocol/rest/**
# Apply aggressive obfuscation to internal implementation
# Repackage all classes to make reverse engineering harder
-repackageclasses 'com.timecho'

# Allow more aggressive optimizations
-allowaccessmodification
-mergeinterfacesaggressively
-overloadaggressively

-dontusemixedcaseclassnames

# Remove debug information in release
# -printmapping obfuscation-mapping.txt
# -printseeds obfuscation-seeds.txt
# -printusage obfuscation-usage.txt

# Don't warn about missing classes (external dependencies)
-dontwarn javax.**
-dontwarn org.slf4j.**
-dontwarn org.apache.log4j.**
-dontwarn org.apache.commons.**
-dontwarn com.google.**
-dontwarn io.netty.**
-dontwarn scala.**

# 保留所有 JAX-RS 注解和路径配置
-keep @javax.ws.rs.Path class *
-keepclassmembers class * {
    @javax.ws.rs.* *;
}
# 保留 Servlet 和 Context 相关类
-keep class javax.servlet.** { *; }
-keep class javax.ws.rs.** { *; }
-keep class org.glassfish.jersey.** { *; }

-keep @io.swagger.annotations.Api class *
-keepclassmembers class * {
    @io.swagger.annotations.* *;
}

# # Keep class TypeToken (respectively its generic signature) if present
# -if class com.google.gson.reflect.TypeToken
# -keep,allowobfuscation class com.google.gson.reflect.TypeToken

# # Keep any (anonymous) classes extending TypeToken
# -keep,allowobfuscation class * extends com.google.gson.reflect.TypeToken

# # Keep classes with @JsonAdapter annotation
# -keep,allowobfuscation,allowoptimization @com.google.gson.annotations.JsonAdapter class *

# # Keep fields with any other Gson annotation
# # Also allow obfuscation, assuming that users will additionally use @SerializedName or
# # other means to preserve the field names
# -keepclassmembers,allowobfuscation class * {
#   @com.google.gson.annotations.Expose <fields>;
#   @com.google.gson.annotations.JsonAdapter <fields>;
#   @com.google.gson.annotations.Since <fields>;
#   @com.google.gson.annotations.Until <fields>;
# }

# # Keep no-args constructor of classes which can be used with @JsonAdapter
# # By default their no-args constructor is invoked to create an adapter instance
# -keepclassmembers class * extends com.google.gson.TypeAdapter {
#   <init>();
# }
# -keepclassmembers class * implements com.google.gson.TypeAdapterFactory {
#   <init>();
# }
# -keepclassmembers class * implements com.google.gson.JsonSerializer {
#   <init>();
# }
# -keepclassmembers class * implements com.google.gson.JsonDeserializer {
#   <init>();
# }

# # Keep fields annotated with @SerializedName for classes which are referenced.
# # If classes with fields annotated with @SerializedName have a no-args
# # constructor keep that as well. Based on
# # https://issuetracker.google.com/issues/150189783#comment11.
# # See also https://github.com/google/gson/pull/2420#discussion_r1241813541
# # for a more detailed explanation.
# -if class *
# -keepclasseswithmembers,allowobfuscation class <1> {
#   @com.google.gson.annotations.SerializedName <fields>;
# }
# -if class * {
#   @com.google.gson.annotations.SerializedName <fields>;
# }
# -keepclassmembers,allowobfuscation,allowoptimization class <1> {
#   <init>();
# }